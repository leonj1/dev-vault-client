# Use .NET 8 SDK as the base image
FROM mcr.microsoft.com/dotnet/sdk:8.0

# Set working directory
WORKDIR /app

# Copy solution and project files
COPY src/*.sln ./src/
COPY src/CrossPlatformApp.CLI/*.csproj ./src/CrossPlatformApp.CLI/
COPY src/CrossPlatformApp.Tests/*.csproj ./src/CrossPlatformApp.Tests/

# Restore NuGet packages
WORKDIR /app/src
RUN dotnet restore

# Copy the rest of the source code
COPY src/CrossPlatformApp.CLI/. ./CrossPlatformApp.CLI/
COPY src/CrossPlatformApp.Tests/. ./CrossPlatformApp.Tests/

# Create coverage directory
RUN mkdir -p /app/testresults/coverage && chmod 777 /app/testresults/coverage

# Run tests with coverage
CMD ["dotnet", "test", "--logger:trx", "--results-directory", "/app/testresults", "/p:CollectCoverage=true", "/p:CoverletOutput=/app/testresults/coverage/coverage.cobertura.xml", "/p:CoverletOutputFormat=cobertura"]
